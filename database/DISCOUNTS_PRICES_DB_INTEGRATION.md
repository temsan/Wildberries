# üí∞ Discounts-Prices DB Integration

–ü–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –ø—Ä—è–º—É—é —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## üéØ –ß—Ç–æ —ç—Ç–æ

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω –∏ —Å–∫–∏–¥–æ–∫ –∏–∑ Wildberries API –Ω–∞–ø—Ä—è–º—É—é –≤ PostgreSQL/Supabase, –º–∏–Ω—É—è Google Sheets.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
WB Discounts-Prices API ‚Üí DiscountsPricesDBProcessor ‚Üí PostgreSQL/Supabase
                                     ‚Üì
                            validation_logs (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
                            price_history (–∏—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω)
                            unit_economics (—Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã)
```

## üìÅ –§–∞–π–ª—ã

- `discounts_prices_enhanced.py` - –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
- `run_discounts_prices_sync.py` - CLI —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞
- `discounts_prices_db.py` - –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫
```bash
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤
python database/run_discounts_prices_sync.py

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
python database/run_discounts_prices_sync.py --test-only

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
python database/run_discounts_prices_sync.py --max-goods 500
```

### 2. –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
```bash
# –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
python database/run_discounts_prices_sync.py \
    --max-goods 1000 \
    --batch-size 100 \
    --sleep 2.0 \
    --analytics \
    --export exports/prices.json
```

### 3. –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ
```python
from database.integrations.discounts_prices_enhanced import DiscountsPricesDBProcessor

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
processor = DiscountsPricesDBProcessor()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
connections = processor.test_connections()

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
stats = processor.sync_prices_to_db(max_goods=1000)

# –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
analytics = processor.get_price_analytics(days=7)

# –≠–∫—Å–ø–æ—Ä—Ç
processor.export_to_json("prices.json", max_goods=500)
```

## üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

### CLI –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `--max-goods` - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
- `--batch-size` - –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50)
- `--sleep` - –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1.0—Å)
- `--export` - –ü—É—Ç—å –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ JSON
- `--analytics` - –ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `--test-only` - –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

### API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- `page_size` - –†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã API (50-1000)
- `sleep_seconds` - –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (1.0+)
- `max_pages` - –õ–∏–º–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. API –∫–ª—é—á–∏
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `api_keys.py`:
```python
# Discounts-Prices API
AUTHORIZEV3_TOKEN = "your_jwt_token_here"
COOKIES = "wbx-validation-key=...; x-supplier-id-external=..."
USER_AGENT = "Mozilla/5.0..."
```

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ë–î –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞:
```python
# Supabase
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_KEY = "your_anon_key"
```

## üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤
- –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏
- –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏

### –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω
- –¢–æ–≤–∞—Ä—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ü–µ–Ω
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã
- –î–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ü—Ä–∏–º–µ—Ä –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
```json
{
  "statistics": {
    "total_products": 1234,
    "avg_price": 2450.50,
    "min_price": 100.00,
    "max_price": 50000.00,
    "products_with_discount": 567,
    "avg_discount": 15.3
  },
  "price_changes": [
    {
      "nm_id": 12345,
      "vendor_code": "VC001",
      "changes_count": 5,
      "min_price": 1200.00,
      "max_price": 1500.00,
      "price_difference": 300.00
    }
  ]
}
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î (PostgreSQL/Supabase)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ API (Discounts-Prices)

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –ò—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º API
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (401, 429)

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –í–∞–ª–∏–¥–∞—Ü–∏—è nmID
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ü–µ–Ω (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
- –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –ø–æ—Å–ª–µ –°–ü–ü
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ-–∞–∫—Ü–∏–π

### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
- Upsert –≤ `unit_economics`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ `price_history`
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ `validation_logs`

### 5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## üìã –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `validation_logs`:

```sql
SELECT * FROM validation_logs 
WHERE operation_type = 'sync_discounts_prices' 
ORDER BY timestamp DESC;
```

### –ü–æ–ª—è –ª–æ–≥–∞
- `operation_type` - –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
- `status` - –°—Ç–∞—Ç—É—Å (success/warning/error)
- `records_processed` - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π
- `records_failed` - –û—à–∏–±–æ–∫
- `input_data` - –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
- `validation_errors` - –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫
- `execution_time_ms` - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### API –æ—à–∏–±–∫–∏
- **401 Unauthorized** - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω
- **429 Too Many Requests** - –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
- **Timeout** - –ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç

### –ë–î –æ—à–∏–±–∫–∏
- **Connection** - –ü—Ä–æ–±–ª–µ–º—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **Constraint** - –ù–∞—Ä—É—à–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **Data** - –û—à–∏–±–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫
- –ü—Ä–æ–ø—É—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
python database/run_discounts_prices_sync.py --test-only

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
python -c "
from database.db_client import get_client
client = get_client()
logs = client.client.table('validation_logs').select('*').eq('operation_type', 'sync_discounts_prices').order('timestamp', desc=True).limit(5).execute()
print(logs.data)
"
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (—Ç–æ–≤–∞—Ä–æ–≤/—Å–µ–∫)
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º:

1. **–í–∫–ª–∞–¥–∫–∞ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è"** - –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. **–í–∫–ª–∞–¥–∫–∞ "–¶–µ–Ω—ã"** - –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
3. **–í–∫–ª–∞–¥–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω"** - –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. **–í–∫–ª–∞–¥–∫–∞ "–õ–æ–≥–∏"** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ–ø–µ—Ä–∞—Ü–∏–π

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å Google Sheets

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Google Sheets | –ë–î Integration |
|----------|---------------|----------------|
| –°–∫–æ—Ä–æ—Å—Ç—å | –ú–µ–¥–ª–µ–Ω–Ω–æ | –ë—ã—Å—Ç—Ä–æ |
| –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç API | –í—ã—Å–æ–∫–∞—è |
| –ò—Å—Ç–æ—Ä–∏—è | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | –ë–∞–∑–æ–≤–∞—è | –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è |
| –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è | –°–ª–æ–∂–Ω–∞—è | –ü—Ä–æ—Å—Ç–∞—è |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π | –ü–æ–ª–Ω—ã–π |

## üéâ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å –ë–î
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –æ—Ç–∫–∞—Ç—ã
3. **–ò—Å—Ç–æ—Ä–∏—è** - –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω
4. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - SQL –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç—á–µ—Ç—ã
5. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - Cron –∑–∞–¥–∞—á–∏ –∏ API
6. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏

## üîÆ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - Cron –∑–∞–¥–∞—á–∏
2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - Email/Telegram –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
3. **–î–∞—à–±–æ—Ä–¥—ã** - –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
4. **API** - REST API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
5. **–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ** - –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ü–µ–Ω

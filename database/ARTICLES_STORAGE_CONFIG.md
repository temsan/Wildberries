# üì¶ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—Ä—Ç–∏–∫—É–ª–æ–≤

## üéØ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ú–∞–∫–∞—Ä–∞

### –ò–µ—Ä–∞—Ä—Ö–∏—è —Ç–æ–≤–∞—Ä–æ–≤:
```
–ê–†–¢–ò–ö–£–õ (nmID) - –æ—Å–Ω–æ–≤–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ –ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞ (vendorCode) - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    ‚îî‚îÄ‚îÄ –ë–ê–†–ö–û–î–´ = –†–ê–ó–ú–ï–†–´ (M, L, XL) - –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã
```

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: –ü–æ –∞—Ä—Ç–∏–∫—É–ª—É (nmID) —Ü–µ–ª–∏–∫–æ–º
- **–ó–∞–∫—É–ø–∫–∏**: –ü–æ –∞—Ä—Ç–∏–∫—É–ª—É (–∫–∞–∫–∏—Ö-—Ç–æ –±–æ–ª—å—à–µ, –∫–∞–∫–∏—Ö-—Ç–æ –º–µ–Ω—å—à–µ)
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤**: –†–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- **–¶–µ–Ω—ã**: –û–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∞—Ä—Ç–∏–∫—É–ª–∞

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### 1. PRODUCTS (–æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∞—Ä—Ç–∏–∫—É–ª–æ–≤)
```sql
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    nm_id INTEGER NOT NULL UNIQUE,           -- –ê—Ä—Ç–∏–∫—É–ª WB (–æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
    vendor_code VARCHAR(255) NOT NULL,       -- –ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞ (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
    brand VARCHAR(255),                      -- –ë—Ä–µ–Ω–¥
    title TEXT,                              -- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    subject VARCHAR(255),                    -- –ö–∞—Ç–µ–≥–æ—Ä–∏—è/–∫–ª–∞—Å—Å —Ç–æ–≤–∞—Ä–∞
    volume DECIMAL(10,3),                    -- –û–±—ä–µ–º —É–ø–∞–∫–æ–≤–∫–∏ (–ª)
    active BOOLEAN DEFAULT true,             -- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É (nmID)

### 2. SELLER_ARTICLES (—Ä–∞–∑–º–µ—Ä—ã/–±–∞—Ä–∫–æ–¥—ã)
```sql
CREATE TABLE seller_articles (
    id BIGSERIAL PRIMARY KEY,
    nm_id INTEGER NOT NULL REFERENCES products(nm_id), -- –°–≤—è–∑—å —Å –∞—Ä—Ç–∏–∫—É–ª–æ–º
    vendor_code VARCHAR(255) NOT NULL,                  -- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    barcode VARCHAR(255) NOT NULL UNIQUE,               -- –®—Ç—Ä–∏—Ö–∫–æ–¥ = —Ä–∞–∑–º–µ—Ä (M, L, XL)
    size VARCHAR(100),                                  -- –†–∞–∑–º–µ—Ä —Ç–æ–≤–∞—Ä–∞
    active BOOLEAN DEFAULT true,                        -- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–º–µ—Ä–∞
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã —Ç–æ–≤–∞—Ä–∞ (—Ä–∞–∑–º–µ—Ä—ã), —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∞—Ä—Ç–∏–∫—É–ª–æ–º

## üìä –¢–∏–ø —Ö—Ä–∞–Ω–µ–Ω–∏—è: –ü–†–û–°–¢–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï

### ‚úÖ –ß—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏):
- **–ê—Ä—Ç–∏–∫—É–ª (nmID)** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- **–ê—Ä—Ç–∏–∫—É–ª –ø—Ä–æ–¥–∞–≤—Ü–∞ (vendorCode)** - —Ä–µ–¥–∫–æ –º–µ–Ω—è–µ—Ç—Å—è
- **–ë–∞—Ä–∫–æ–¥** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—Ä–∞
- **–†–∞–∑–º–µ—Ä** - –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç
- **–ù–∞–∑–≤–∞–Ω–∏–µ** - —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è
- **–ö–∞—Ç–µ–≥–æ—Ä–∏—è WB** - —Ç–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
- **–ë—Ä–µ–Ω–¥** - —Ç–µ–∫—É—â–∏–π –±—Ä–µ–Ω–¥
- **–û–±—ä–µ–º** - —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–º

### üîÑ –ß—Ç–æ –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã:
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞–∑–≤–∞–Ω–∏–π
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –±—Ä–µ–Ω–¥–æ–≤
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–æ–≤

## üéØ –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ä—Ç–∏–∫—É–ª–∞:
```python
# –û—Å–Ω–æ–≤–Ω–æ–π –∞—Ä—Ç–∏–∫—É–ª (nmID)
product_data = {
    'nm_id': 12345,
    'vendor_code': 'NIK-001',
    'brand': 'Nike',
    'title': '–§—É—Ç–±–æ–ª–∫–∞ Nike Sport',
    'subject': '–û–¥–µ–∂–¥–∞',
    'volume': 0.1
}

# –†–∞–∑–º–µ—Ä—ã/–±–∞—Ä–∫–æ–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞
variants = [
    {'barcode': '1234567890123', 'size': 'M'},
    {'barcode': '1234567890124', 'size': 'L'},
    {'barcode': '1234567890125', 'size': 'XL'}
]
```

### 2. –§—É–Ω–∫—Ü–∏—è upsert:
```sql
-- –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∞—Ä—Ç–∏–∫—É–ª –∏ –≤—Å–µ –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
SELECT upsert_product_with_variants(
    p_nm_id := 12345,
    p_vendor_code := 'NIK-001',
    p_brand := 'Nike',
    p_title := '–§—É—Ç–±–æ–ª–∫–∞ Nike Sport',
    p_subject := '–û–¥–µ–∂–¥–∞',
    p_volume := 0.1,
    p_variants := '[
        {"barcode": "1234567890123", "size": "M", "active": true},
        {"barcode": "1234567890124", "size": "L", "active": true},
        {"barcode": "1234567890125", "size": "XL", "active": true}
    ]'::jsonb
);
```

## üìà –ó–∞–ø—Ä–æ—Å—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü–æ–ª—É—á–∏—Ç—å –∞—Ä—Ç–∏–∫—É–ª —Å–æ –≤—Å–µ–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏:
```sql
SELECT 
    p.nm_id,
    p.vendor_code,
    p.brand,
    p.title,
    sa.barcode,
    sa.size,
    sa.active
FROM products p
LEFT JOIN seller_articles sa ON p.nm_id = sa.nm_id
WHERE p.nm_id = 12345
ORDER BY sa.size;
```

### 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º:
```sql
SELECT 
    COUNT(*) as total_articles,
    COUNT(DISTINCT p.nm_id) as unique_articles,
    COUNT(sa.id) as total_sizes,
    AVG(size_count.sizes_per_article) as avg_sizes_per_article
FROM products p
LEFT JOIN seller_articles sa ON p.nm_id = sa.nm_id
LEFT JOIN (
    SELECT nm_id, COUNT(*) as sizes_per_article
    FROM seller_articles
    GROUP BY nm_id
) size_count ON p.nm_id = size_count.nm_id;
```

### 3. –¢–æ–ø –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Ä–∞–∑–º–µ—Ä–æ–≤:
```sql
SELECT 
    p.nm_id,
    p.vendor_code,
    p.brand,
    p.title,
    COUNT(sa.id) as sizes_count
FROM products p
LEFT JOIN seller_articles sa ON p.nm_id = sa.nm_id
WHERE p.active = true
GROUP BY p.nm_id, p.vendor_code, p.brand, p.title
ORDER BY sizes_count DESC
LIMIT 20;
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –í DiscountsPricesDBProcessor:
```python
def _extract_variants(self, item: Dict[str, Any]) -> List[Dict[str, Any]]:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–æ–≤–∞—Ä–∞ (–±–∞—Ä–∫–æ–¥—ã = —Ä–∞–∑–º–µ—Ä—ã).
    
    –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:
    - –ë–∞—Ä–∫–æ–¥ = –†–∞–∑–º–µ—Ä —Ç–æ–≤–∞—Ä–∞ (M, L, XL)
    - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ = –ü–æ –∞—Ä—Ç–∏–∫—É–ª—É (nmID) —Ü–µ–ª–∏–∫–æ–º
    - –¶–µ–Ω—ã = –û–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    """
    variants = []
    
    # –ü–æ–ª—É—á–∞–µ–º –±–∞—Ä–∫–æ–¥—ã –∏–∑ API
    barcodes = item.get('barcodes', [])
    if not barcodes:
        barcodes = item.get('barcode', [])
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –±–∞—Ä–∫–æ–¥ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
    for i, barcode in enumerate(barcodes):
        if barcode and str(barcode).strip():
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä
            size = self._determine_size(item, i)
            
            variant = {
                'barcode': str(barcode).strip(),
                'size': size,
                'active': True
            }
            variants.append(variant)
    
    return variants

def _determine_size(self, item: Dict[str, Any], index: int) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä –¥–ª—è –±–∞—Ä–∫–æ–¥–∞."""
    sizes = item.get('sizes', [])
    if sizes and index < len(sizes):
        return sizes[index]
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ –∏–Ω–¥–µ–∫—Å—É
    size_options = ['XS', 'S', 'M', 'L', 'XL', 'XXL']
    return size_options[index] if index < len(size_options) else f'Size_{index+1}'
```

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ç–∞–∫–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** - –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É (nmID)
2. **–≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞** - –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
3. **–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - –∏–Ω–¥–µ–∫—Å—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–æ–ª—è–º
4. **–ì–∏–±–∫–æ—Å—Ç—å —Ä–∞–∑–º–µ—Ä–æ–≤** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å —Ä–∞–∑–º–µ—Ä—ã
5. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ** - –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ú–∞–∫–∞—Ä

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞—Ä—Ç–∏–∫—É–ª–æ–≤:
```bash
python database/run_discounts_prices_sync.py --max-goods 100
```

### –¢–µ—Å—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏:
```bash
python database/test_product_hierarchy.py
```

### –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
```bash
python database/web_interface.py
# –û—Ç–∫—Ä—ã—Ç—å: http://localhost:8501
```
